<!DOCTYPE html>
<html lang="es-VE">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="Author" content="Manuel Martinez" />
        <meta name="Description" content="Jugar Batalla Naval desde 2 a 4 personas" />
        <meta name="keywords" content="HTML, CSS, JS, Batalla Naval, juego" />
        <meta name="robots" content="noindex, nofollow" />
        <!-- 
        <link rel="stylesheet" href="barraDeNavegacion.css">
        <link rel="stylesheet" href="tablero.css">
        -->
        <link rel="stylesheet" href="./styles/barraDeNavegacion.css">
        <link rel="stylesheet" href="./styles/tablero.css">

        <title>Batalla Naval | Instrucciones</title>
    </head>
    <body>
        <header>
            <h1><img src="./images/Batalla_Naval_Icon.png" alt="Icono Batalla Naval"> Batalla Naval</h1>
            <nav class="navbar">
                <ul>
                    <li><a href="inicio.html">Inicio</a></li>
                    <li><a href="instrucciones.html">Instrucciones</a></li>
                    <li><a href="jugar.html">Jugar</a></li>
                </ul>
            </nav>
        </header>

        <main>
    
            <div id="tablero">
                      
            </div>
    

            <aside id="side-menu">
                <h2>Datos del Turno</h2>
                <div id="datos-del-turno">
                    <h2 id="indicador-Turno">Turno del Jugador: X</h2>
                    <h2 id="indicador-tablero">Tablero del Jugador X</h2>
                    <h2>Puntos Restantes: XXXXX</h2>
                </div>
                <h2 id="titulo-powerups">Inventario de PowerUPs</h2>
                    <ul id="inventario-powerups">
                        <li id="boton-sonar" powerUp="sonar" >Sonar 
                            <ul class="descripcion-powerup">
                            <li>Disponible mientras el submarino no haya sido hundido.</li>
                            <li>Revela una casilla al azar de un barco enemigo.</li>
                            <li>Costo: 5 puntos por uso.</li>
                            </ul>
                        </li>
                        <li id="boton-sonar" powerUp="avionesDeAtaque">Aviones de Ataque
                            <ul class="descripcion-powerup">
                                <li>Disponible mientras el portaaviones no haya sido hundido.</li>
                                <li>Lanza hasta 5 misiles al azar en el tablero enemigo.</li>
                                <li>Costo: 10 puntos por uso.</li>
                            </ul>
                        </li>
                        <li id="boton-sonar" powerUp="minaMarina">Mina Marina
                            <ul class="descripcion-powerup">
                                <li>Los jugadores pueden plantar una mina en su propio tablero.</li>
                                <li>Si el enemigo ataca una mina, recibe un "hit" adicional en una casilla adyacente al azar.</li>
                                <li>Costo: 5 puntos para plantar</li>
                            </ul>
                        </li>
                        <li id="boton-sonar" powerUp="escudoDefensivo">Escudo Defensivo
                            <ul class="descripcion-powerup">
                                <li>Protege una región de 3x3 casillas durante 3 turnos.</li>
                                <li>Los ataques en el área protegida son anulados y el enemigo recibe un mensaje de "Bloqueado".</li>
                                <li>Costo: 15 puntos.</li>
                            </ul>
                        </li>
                        <li id="boton-sonar" powerUp="misilCrucero">Misil Crucero
                            <ul class="descripcion-powerup">
                                <li>Ataque dirigido a un área de 3x3 casillas.</li>
                                <li>Costo: 15 puntos.</li>
                                <li>Tiempo de recarga: 5 turnos.</li>
                            </ul>
                        </li>
                        <li id="boton-sonar" powerUp="reparacionRapida">Reparación Rápida
                            <ul  class="descripcion-powerup">
                                <li>Restaura hasta 2 casillas de un barco dañado (no hundido).</li>
                                <li>Costo: 10 puntos.</li>
                                <li>Un solo uso por barco.</li>
                            </ul>
                        </li>
                        <li id="boton-sonar" powerUp="emp">Ataque EMP
                            <ul  class="descripcion-powerup">
                                <li>Desactiva todas las funciones especiales del enemigo durante 3 turnos.</li>
                                <li>Costo: 25 puntos.</li>
                                <li>Tiempo de recarga: 10 turnos.</li>
                            </ul>
                        </li>
                    </ul>
                    <div id="control-tablero">
                        <!-- <h2 class="cambiar-tablero1">Cambiar a tablero J1</h2>
                        <h2 class="cambiar-tablero2">Cambiar a tablero J2</h2>
                        <h2 class="cambiar-tablero3">Cambiar a tablero J3</h2>
                        <h2 class="cambiar-tablero4">Cambiar a tablero J4</h2> -->
                    </div>

                    <div id="control-piezas">
                        <h2>Establecer Piezas</h2>
                        <div id="boton-rotar">
                            <h3 style="line-height: normal" >Da click para rotar</h3>
                        </div>
                        <div>
                            <p id="texto-rotacion">
                                Tu pieza irá: de izquierda a Derecha
                            </p>
                        </div>
                        
                        <div id="div-cabezas">

                            <div class="container portaviones" id="container1">
                                <div class="dragHead " id="portaviones" draggable="true" largo="5">x5</div>
                            </div>

                            <div class="container acorazado" id="container2">
                                <div class="dragHead" id="acorazado" draggable="true" largo="4">x4</div>
                            </div>

                            <div class="container crucero" id="container3">
                                <div class="dragHead" id="crucero" draggable="true" largo="3">x3</div>
                            </div>

                            <div class="container submarino" id="container4">
                                <div class="dragHead" id="submarino" draggable="true" largo="3">x3</div>
                            </div>

                            <div class="container destructor" id="container5">
                                <div class="dragHead" id="destructor" draggable="true" largo="2">x2</div>
                            </div>

                        </div>
                        
                    </div>

                    <h2 id="boton-iniciar">Iniciar Juego</h2>

            </aside>
            <br>
            
            
            

        </main>

        <script>

            const WEBSOCKET_SCHEME = 'ws';
            const WEBSOCKET_SERVER = 'localhost';
            const WEBSOCKET_PORT = 8000;
            const WEBSOCKET_URL = `${WEBSOCKET_SCHEME}://${WEBSOCKET_SERVER}:${WEBSOCKET_PORT}`;
            const socket = new WebSocket(WEBSOCKET_URL);
            console.log(WEBSOCKET_URL);

            let nombreJugador = "PlaceHolder";
            let juegoId = "1";
            let crear = "1";
            let orientacion = ["izq-dere", "arr-abj", "dere-izq", "abj-arr"];
            let indiceOrientacion= 0;
            let tamano = 5;
            let tipo = "portaviones";
            let powerUpActivo = "disparar";
            let partidaIniciada = false;
            let mostrandoMenu;
            definirDatos();
            let botonesPosicion = document.getElementsByClassName("boton-pieza");
            let casillas = document.getElementsByClassName("position");

            let juego;

            class Jugada{
                jugadorAfectado;
                X;
                Y;
                orientacion;
                grupo;
                descripcion;
                tablero;
                constructor(afectado, posX, posY, descripcion, table, orientacion = "izq-dere", grupo = "agua" ){
                    this.jugadorAfectado = afectado;
                    this.X = posX;
                    this.Y = posY;
                    this.descripcion = descripcion;
                    this.tablero = table;
                    this.orientacion = orientacion;
                    this.grupo = grupo;
                }
            }
            
            class mensaje{
                type;
                id;
                jugador;
                jugada;
                pieza;
                constructor(type, id, jugador, jugada = new Jugada('nadie', 0, 0, 'nada'), pieza= "nada"){
                    this.type = type;
                    this.id = id;
                    this.jugador = jugador;
                    this.jugada = jugada;
                    this.pieza = pieza;
                }
            }



            function definirDatos() {
                let urlParams = new URLSearchParams(window.location.search);
                nombreJugador = urlParams.get('jugador');
                juegoId = urlParams.get('id');
                crear = urlParams.get('create');
                mostrandoMenu = nombreJugador;
                // console.log(nombreJugador);
                // console.log(juegoId);
            }

            

            function configurarMenuPowerUps(){
                document.getElementById("titulo-powerups").style.display = "block";
                document.getElementById("inventario-powerups").style.display = "block";
                let lis = document.getElementById("inventario-powerups").getElementsByTagName("li");
                for (let i = 0; i < lis.length; i++){
                    lis[i].addEventListener("click", ()=> {
                        powerUpActivo = (powerUpActivo == "disparar")? lis[i].getAttribute("powerUp") : "disparar";
                    })
                }

            }

            document.getElementById("boton-iniciar").addEventListener('click', ()=>{
                socket.send(JSON.stringify(new mensaje("start", juegoId, nombreJugador)));
            })

            function configurarSideMenu(){
                document.getElementById("boton-iniciar").style.display = "none"; 
                document.getElementById("control-tablero").style.display = "block";
                let nombreAux = '';
                let hijo;
                for( const jugador of juego.jugadores){
                    hijo = document.createElement("h2");
                    let nombreAux = jugador.nombre;
                    hijo.textContent = "Cambiar Al tablero de " + jugador.nombre;
                    document.getElementById("control-tablero").appendChild(hijo);
                    hijo.addEventListener("click", () =>{
                        mostrandoMenu = jugador.nombre;
                        document.getElementById("indicador-tablero").textContent =" Tablero del Jugador: "+ mostrandoMenu;
                        imprimirTablero(mostrandoMenu);
                        agregarEventoACasillas(mostrandoMenu);
                    })
                }
            }


            document.getElementById("boton-rotar").addEventListener("click", ()=> {
                // console.log()
                if (indiceOrientacion == 3){
                    indiceOrientacion = 0;
                } else {
                    indiceOrientacion++;
                }
                orientacion[indiceOrientacion];
                console.log(orientacion[indiceOrientacion]);

                switch(orientacion[indiceOrientacion]){
                    case "izq-dere":
                        document.getElementById('texto-rotacion').textContent = 'Tu pieza irá: de Izquierda a Derecha';
                        break;
                    case "dere-izq":
                        document.getElementById('texto-rotacion').textContent = 'Tu pieza irá: de Derecha a Izquierda';
                        break;
                    case "arr-abj":
                        document.getElementById('texto-rotacion').textContent = 'Tu pieza irá: de Arriba a Abajo';
                        break;
                    case "abj-arr":
                        document.getElementById('texto-rotacion').textContent = 'Tu pieza irá: de Abajo a Arriba';
                        break;
                }

            })
            function enviarMensaje(tipo, id, jugador){
                socket.send(JSON.stringify(new mensaje(tipo, id, jugador)));
            }

            function imprimirTablero(nombre){
                let tableroHTML = document.getElementById("tablero");
                while (tableroHTML.firstChild) {
                    tableroHTML.removeChild(tableroHTML.lastChild);
                }
                for (const jugador of juego.jugadores){
                    if (jugador.nombre == nombre){
                        console.log("Nombre: " + nombre);
                        dibujarTablero(jugador.tablero, (nombre == nombreJugador));
                    }
                }
            }

            socket.addEventListener('message', (event) =>{
                let mensajeRecibido = JSON.parse(event.data);
                // console.log(mensajeRecibido);

                switch(mensajeRecibido.type){
                    case "error":
                        alert(mensajeRecibido.descripcion);
                        break;
                    case "tablero":
                        juego = mensajeRecibido.tablero;
                        document.getElementById("indicador-Turno").textContent = "Turno del Jugador: " + juego.jugadores[juego.jugadorActual].nombre;
                        imprimirTablero(mostrandoMenu);
                        casillas = document.getElementsByClassName("position");
                        agregarEventoACasillas();
                        break;
                    case "inicio":
                        mostrandoMenu = nombreJugador;
                        juego = mensajeRecibido.tablero;
                        document.getElementById("indicador-Turno").textContent = "Turno del Jugador: " + juego.jugadores[juego.jugadorActual].nombre;
                        imprimirTablero(mostrandoMenu);
                        casillas = document.getElementsByClassName("position");
                        agregarEventoACasillas();
                        configurarMenuPowerUps();
                        console.log("asl");
                        configurarSideMenu();
                        console.log("huh");
                    break;
                    case "eliminacion":
                        alert(mensaje.juego);
                        break;
                }
            });

            socket.addEventListener('open', (event) =>{
                // console.log(crear);
                if (crear == "1"){
                    // console.log("crear");
                    enviarMensaje("create", juegoId, nombreJugador);
                } else {
                    // console.log("unir");
                    enviarMensaje("join", juegoId, nombreJugador);
                }
            });

            function dibujarTablero(tablero, propio){
                let hijo;
                // console.log(tablero);
                for (const linea of tablero){
                    // console.log("linea procesando:");
                    // console.log(linea);
                    for (const casilla of linea){
                        // console.log(casilla);
                        hijo = document.createElement("div");
                        hijo.setAttribute("posX", casilla.posX.toString());
                        hijo.setAttribute("posY", casilla.posY.toString());
                        hijo.setAttribute("visible", (propio)? "true":casilla.visible.toString());
                        hijo.setAttribute("golpeada", casilla.golpeada.toString());
                        hijo.setAttribute("grupo", casilla.grupo);
                        hijo.setAttribute("orientacion", casilla.orientacion)
                        hijo.classList.add("position");
                        // console.log(`QUE PASA TIOOO: ${casilla.tipo}`)
                        hijo.classList.add(casilla.tipo);
                        document.getElementById('tablero').appendChild(hijo);
                    }
                }
            }

            function comprobarEspacios(){

            }

           

            function insertarBarco(orientacion, tamano, tipo, posX, posY, draggeado){
                // console.log('akdjf');
                let tablero = obtenerTablero();
                let posAX = Number(posX);
                let posAY = Number(posY);
                let i = 0;
                let j = 0;
                let ocupado = false;

                let tamanoAux = tamano
                console.log(`A: ${tamano}`);
                console.log(`B: ${posY}`);
                console.log(`C: ${posAY+tamano}` );
                switch(orientacion){
                    case "izq-dere":
                        while(tamanoAux > 0 && posAX+tamano <= 10 && ocupado == false){
                            let grupo = tablero[posAY][posAX+j].grupo;
                            if(grupo !== 'mar'){
                                ocupado = true;
                            }
                            tamanoAux--;
                            j++;
                        }
                        

                        if(posAX+tamano-1 <= 10 && ocupado == false){
                            while(tamano > 0){
                                console.log("prueba1");
                                tablero[posAY][posAX+i].tipo = tipo + tamano.toString();
                                console.log(`CREO QUE LO ENCONTRE: ${tamano}`)
                                tablero[posAY][posAX+i].grupo = tipo;
                                tablero[posAY][posAX+i].orientacion = orientacion;
                                console.log("fin");
                                tamano--;
                                i++;
                            }
                            draggeado.remove();
                        } else{
                            console.log("ERRROOOOOOORRRRR SE SALE DEL ARRRAAAAYYY");
                            tipo = "salido";
                        }
                        break;

                    case "dere-izq":
                        while(tamanoAux > 0 && posAX-tamano >= 1 && ocupado == false){
                            let grupo = tablero[posAY][posAX-j].grupo;
                            if(grupo !== 'mar'){
                                ocupado = true;
                            }
                            tamanoAux--;
                            j++;
                        }
                        console.log(`SISISI: ${ocupado}`);
                        console.log(`SISISI: ${posAX}`);
                        console.log(`SISISI: ${tamano}`);
                        console.log(`SISISI: ${posAX-tamano+1}`);

                        if(posAX-tamano+1 >= 1 && ocupado == false){
                            while(tamano > 0){
                                console.log("prueba1");
                                        tablero[posAY][posAX-i].tipo = tipo + tamano.toString();
                                        tablero[posAY][posAX-i].grupo = tipo;
                                        tablero[posAY][posAX-i].orientacion = orientacion;
                                        tamano--;
                                        i++

                                    }
                                    draggeado.remove();
                            } else{
                                console.log("ERRROOOOOOORRRRR SE SALE DEL ARRRAAAAYYY");
                                tipo = "salido";
                            }
                        break;

                    case "arr-abj":
                        while(tamanoAux > 0 && posAY+tamano <= 10 && ocupado == false){
                            let grupo = tablero[posAY+j][posAX].grupo;
                            if(grupo !== 'mar'){
                                ocupado = true;
                            }
                            tamanoAux--;
                            j++;
                        }

                        if(posAY+tamano-1 <= 10 && ocupado == false){

                            while(tamano > 0){
                                console.log("prueba1");
                                        tablero[posAY+i][posAX].tipo = tipo + tamano.toString();
                                        tablero[posAY+i][posAX].grupo = tipo;
                                        tablero[posAY+i][posAX].orientacion = orientacion;
                                        tamano--;
                                        i++
                                    }
                                    draggeado.remove();
                            } else{
                                console.log("ERRROOOOOOORRRRR SE SALE DEL ARRRAAAAYYY");
                                tipo = "salido";
                                
                            }

                        break;
                    case "abj-arr":
                        while(tamanoAux > 0 && posAY-tamano >= 1 && ocupado == false){
                            let grupo = tablero[posAY-j][posAX].grupo;
                            if(grupo !== 'mar'){
                                ocupado = true;
                            }
                            tamanoAux--;
                            j++;
                        }
                    if(posAY-tamano+1 >= 1 && ocupado == false){
                        while(tamano > 0){
                                    console.log("prueba1");
                                    tablero[posAY-i][posAX].tipo = tipo + tamano.toString();
                                    tablero[posAY-i][posAX].grupo = tipo;
                                    tablero[posAY-i][posAX].orientacion = orientacion;
                                    tamano--;
                                    i++;
                                }
                                draggeado.remove();
                    } else{
                            console.log("ERRROOOOOOORRRRR SE SALE DEL ARRRAAAAYYY");
                            tipo = "salido";
                        }
                        break;
                }
                return tipo;
            }
            // orientacion puede ser izq-dere, dere-izq, arr-abj, abj-arr


         
            function obtenerTablero(){
                for (const jugador of juego.jugadores){
                    if (jugador.nombre == nombreJugador){
                        return jugador.tablero;
                    }
                }
                // console.log("no se encontraron");
            }

            // console.log("1");
            let botonesPoner = document.getElementsByClassName("boton-pieza");
            // console.log(botonesPoner.length);
            for (let i = 0; i < botonesPoner.length; i++) {
                // console.log("2");
                botonesPoner[i].addEventListener('click', () => {
                    switch( botonesPoner[i].id){
                        case "poner-portaviones":
                            tamano = 5;
                            tipo = "portaviones"
                            break;
                        case "poner-acorazado":
                            tamano = 4;
                            tipo = "acorazado"
                            break;
                        case "poner-crucero":
                            tamano = 3;
                            tipo = "crucero"
                            break;
                        case "poner-submarino":
                            tamano = 3;
                            tipo = "submarino"
                            break;
                        case "poner-destructor":
                            tamano = 2;
                            tipo = "destructor";
                            break;
                    }
                })
            }

           
            
            function agregarEventoACasillas(){
                // console.log(casillas.length);
                for (let i = 0; i < casillas.length; i++) {
                    // console.log("djlkf;a");
                    // console.log(juego.iniciado);
                    if(juego.iniciado){
                        casillas[i].addEventListener('click', (e) =>{manejarEventosJuegoIniciado(i)})
                    } else {
                        casillas[i].addEventListener('dragover', function(event) {
                            event.preventDefault();
                        });

                    
                        casillas[i].addEventListener('drop', (e) =>{
                            tipoAux = tipo;

                            console.log(orientacion[indiceOrientacion])
                            console.log(tamano)
                            console.log(tipo)
                            console.log(casillas[i].getAttribute("posY"))
                            console.log(casillas[i].getAttribute("posX"));
                            
                            const id = event.dataTransfer.getData('text');
                            
                            const elementoDragged = document.getElementById(id);

                            console.log(`asjjsakdjsakl: ${document.getElementById(id)}`)

                            if (insertarBarco(orientacion[indiceOrientacion], Number(tamano), tipo, casillas[i].getAttribute("posY"), casillas[i].getAttribute("posX"), elementoDragged) !== 'salido'){
                                let mandar = new mensaje("establecerTablero", juegoId, nombreJugador,new Jugada(nombreJugador, casillas[i].getAttribute("posX"), casillas[i].getAttribute("posY"), "tablero", obtenerTablero(), casillas[i].getAttribute("orientacion"), casillas[i].getAttribute("grupo")), tipo);
        
                                console.log(`MIRAME: ${mandar}`);
                                socket.send(JSON.stringify(mandar));
                            }
                        })
                    }
                }
            }

            const heads = document.querySelectorAll('.dragHead');
            heads.forEach(head => {
                head.addEventListener('dragstart', function(event) {
                    // headId = event.target.id;    
                    tipo = event.target.id;
                    tamano = this.getAttribute('largo');
                    console.log(tipo);           
                    console.log(tamano);
                    event.dataTransfer.setData('text/plain', event.target.id);
                    setTimeout(() => {
                        event.target.style.display = 'none';
                    }, 0);
                });
                head.addEventListener('dragend', function(event) {
                    event.target.style.display = 'block';
                });        
            })

            
            function manejarEventosJuegoIniciado(i){
                let mandar;
                console.log(`accion: ${powerUpActivo}`);
                switch (powerUpActivo){
                case "disparar":
                    mandar = new mensaje("disparar", juegoId, nombreJugador,new Jugada(mostrandoMenu, casillas[i].getAttribute("posX"), casillas[i].getAttribute("posY"), "disparo", obtenerTablero()), tipo);
                    console.log(`ESTO ES MANDAR: ${mandar}`);
                    socket.send(JSON.stringify(mandar));
                    break;
                case "sonar":
                    mandar = new mensaje("sonar", juegoId, nombreJugador,new Jugada(mostrandoMenu, casillas[i].getAttribute("posX"), casillas[i].getAttribute("posY"), "disparo", obtenerTablero()), tipo);
                    console.log(mandar);
                    powerUpActivo = "disparar";
                    socket.send(JSON.stringify(mandar));
                    break;
                case "avionesDeAtaque":
                    mandar = new mensaje("avionesDeAtaque", juegoId, nombreJugador,new Jugada(mostrandoMenu, casillas[i].getAttribute("posX"), casillas[i].getAttribute("posY"), "disparo", obtenerTablero()), tipo);
                    console.log(mandar);
                    powerUpActivo = "disparar";
                    socket.send(JSON.stringify(mandar));
                    break;
                case "minaMarina":
                    mandar = new mensaje("minaMarina", juegoId, nombreJugador,new Jugada(mostrandoMenu, casillas[i].getAttribute("posX"), casillas[i].getAttribute("posY"), "disparo", obtenerTablero()), tipo);
                    console.log(mandar);
                    powerUpActivo = "disparar";
                    socket.send(JSON.stringify(mandar));
                    break;
                case "escudoDefensivo":
                    mandar = new mensaje("escudoDefensivo", juegoId, nombreJugador,new Jugada(mostrandoMenu, casillas[i].getAttribute("posX"), casillas[i].getAttribute("posY"), "disparo", obtenerTablero()), tipo);
                    console.log(mandar);
                    powerUpActivo = "disparar";
                    socket.send(JSON.stringify(mandar));
                    break;
                case "misilCrucero":
                    mandar = new mensaje("misilCrucero", juegoId, nombreJugador,new Jugada(mostrandoMenu, casillas[i].getAttribute("posX"), casillas[i].getAttribute("posY"), "disparo", obtenerTablero()), tipo);
                    console.log(mandar);
                    powerUpActivo = "disparar";
                    socket.send(JSON.stringify(mandar));
                    break;
                case "reparacionRapida":
                    mandar = new mensaje("reparacionRapida", juegoId, nombreJugador,new Jugada(mostrandoMenu, casillas[i].getAttribute("posX"), casillas[i].getAttribute("posY"), "disparo", obtenerTablero()), tipo);
                    console.log(mandar);
                    powerUpActivo = "disparar";
                    socket.send(JSON.stringify(mandar));
                    break;
                case "emp":
                    mandar = new mensaje("emp", juegoId, nombreJugador,new Jugada(mostrandoMenu, casillas[i].getAttribute("posX"), casillas[i].getAttribute("posY"), "disparo", obtenerTablero()), tipo);
                    console.log(mandar);
                    powerUpActivo = "disparar";
                    socket.send(JSON.stringify(mandar));
                    break;
               }           
            }
        </script>

</body>
    
</html>